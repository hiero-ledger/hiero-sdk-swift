name: Swift CI
on:
  pull_request:
  push: 
    branches: ['main']

defaults:
  run:
    shell: bash

permissions:
  contents: read

jobs:
  format:
    runs-on: macos-latest
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0080882f6c36860b6ba35c610c98ce87d4e2f26f # v2.10.2
        with:
          egress-policy: audit

      - name: Checkout Code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install swift-format
        run: brew install swift-format

      - name: Format
        run: swift format lint --strict --configuration .swift-format.json --recursive --parallel Sources/ Tests/ Examples/ Package.swift

  build:
    strategy:
      matrix:
        swift: ["5.9"]
        os: [macos-13]

    runs-on: ${{ matrix.os }}
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0080882f6c36860b6ba35c610c98ce87d4e2f26f # v2.10.2
        with:
          egress-policy: audit

      - name: Setup Swift
        uses: swift-actions/setup-swift@3aed395c5397f62deb91d8fe7af1418a9ae4d16f # v2.1.0
        with:
          swift-version: ${{ matrix.swift }}

      - name: Checkout Code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Cache
        uses: actions/cache@1bd1e32a3bdc45362d1e726936510720a7c30a57 # v4.2.0
        with:
          path: sdk/swift/.build
          key: ${{ runner.os }}-${{ matrix.swift }}-spm-${{ github.job }}-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.swift }}-spm-

      - name: Build
        run: swift build

  test:
    strategy:
      matrix:
        swift: ["5.9"]
        os: [macos-13]
    needs: [build]
    runs-on: ${{ matrix.os }}

    env:
      SOLO_CLUSTER_NAME: solo
      SOLO_NAMESPACE: solo
      SOLO_CLUSTER_SETUP_NAMESPACE: solo-cluster
      SOLO_DEPLOYMENT: solo-deployment
      KIND_IMAGE: kindest/node:v1.33.5
      NO_PROXY: 127.0.0.1,localhost,.svc,.cluster.local,10.0.0.0/8,172.16.0.0/12,192.168.0.0/16,10.96.0.0/12

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0080882f6c36860b6ba35c610c98ce87d4e2f26f
        with:
          egress-policy: audit

      - name: Setup Swift
        uses: swift-actions/setup-swift@3aed395c5397f62deb91d8fe7af1418a9ae4d16f
        with:
          swift-version: ${{ matrix.swift }}

      - name: Checkout Code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      - name: Cache Code
        uses: actions/cache@1bd1e32a3bdc45362d1e726936510720a7c30a57
        with:
          path: sdk/swift/.build
          key: ${{ runner.os }}-${{ matrix.swift }}-spm-${{ github.job }}-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.swift }}-spm-

      # ---- Tooling & Docker/Colima ----
      - name: Install tooling
        run: |
          brew update
          brew install kind kubectl helm jq coreutils go-task

      - name: Start Colima (Docker) and select context
        run: |
          brew install docker
          brew install colima
          colima start --vm-type=vz --cpu=4 --memory=8 --disk=20
          docker context use colima
          docker info

      # ---- Node & local CLI like your script ----
      - name: Setup Node 20 + install deps
        uses: actions/setup-node@v4
        with:
          node-version: "20.18.x"

      - name: Clean any existing kind clusters & ~/.solo
        run: |
          for cluster in $(kind get clusters); do kind delete cluster -n "$cluster" || true; done
          rm -rf ~/.solo || true

      - name: Create kind cluster
        run: |
          kind create cluster -n "${SOLO_CLUSTER_NAME}" --image "${KIND_IMAGE}" --wait 5m --retain -v=1
          kubectl config use-context "kind-${SOLO_CLUSTER_NAME}"
          kubectl cluster-info --context "kind-${SOLO_CLUSTER_NAME}"

      # ---- Build like your local `task build` ----
      - name: Build (task)
        run: task build

      # ---- Solo flow (PROJECT-LOCAL CLI via npm run) ----
      - name: Solo init (local CLI)
        run: npm run solo -- init

      - name: Connect cluster-ref and create deployment (dev)
        run: |
          npm run solo -- cluster-ref connect --cluster-ref "kind-${SOLO_CLUSTER_NAME}" --context "kind-${SOLO_CLUSTER_NAME}" --dev
          npm run solo -- deployment create -n "${SOLO_NAMESPACE}" --deployment "${SOLO_DEPLOYMENT}" --dev

      - name: Add a cluster (1 consensus node) (dev)
        run: |
          npm run solo -- deployment add-cluster \
            -n "${SOLO_NAMESPACE}" \
            --deployment "${SOLO_DEPLOYMENT}" \
            --cluster-ref "kind-${SOLO_CLUSTER_NAME}" \
            --num-consensus-nodes 1 \
            --dev

      - name: Generate node keys (dev)
        run: npm run solo -- node keys -n "${SOLO_NAMESPACE}" --gossip-keys --tls-keys --deployment "${SOLO_DEPLOYMENT}" --dev

      - name: Setup cluster shared components (dev)
        run: npm run solo -- cluster-ref setup -s "${SOLO_CLUSTER_SETUP_NAMESPACE}" --dev

      - name: Deploy network (consensus node only) (dev)
        run: npm run solo -- network deploy -n "${SOLO_NAMESPACE}" --deployment "${SOLO_DEPLOYMENT}" --pvcs --dev

      - name: Node setup/start (dev)
        run: |
          npm run solo -- node setup -n "${SOLO_NAMESPACE}" --deployment "${SOLO_DEPLOYMENT}" --dev
          npm run solo -- node start -n "${SOLO_NAMESPACE}" --deployment "${SOLO_DEPLOYMENT}" --dev

      # Optional: mirror/explorer to match your script
      - name: Mirror & Explorer (dev)  # optional
        run: |
          npm run solo -- mirror-node deploy -n "${SOLO_NAMESPACE}" --deployment "${SOLO_DEPLOYMENT}" --cluster-ref "kind-${SOLO_CLUSTER_NAME}" --enable-ingress --dev
          npm run solo -- explorer deploy -n "${SOLO_NAMESPACE}" --deployment "${SOLO_DEPLOYMENT}" --cluster-ref "kind-${SOLO_CLUSTER_NAME}" --dev

      # ---- Waits & visibility ----
      - name: Wait for workloads
        run: |
          kubectl get ns
          kubectl -n "${SOLO_NAMESPACE}" get all
          kubectl -n "${SOLO_NAMESPACE}" wait --for=condition=available --timeout=600s deploy --all || true
          kubectl -n "${SOLO_NAMESPACE}" wait --for=condition=ready --timeout=600s statefulset --all || true

      - name: K8s snapshot (services/endpoints)
        run: |
          kubectl get svc -A -o wide || true
          kubectl get endpointslices.discovery.k8s.io -A || kubectl get endpoints -A || true

      # ---- Port-forward like your local script ----
      - name: Port-forward services (background)
        run: |
          set -euo pipefail
          # Consensus Service for node1: localhost:50211
          kubectl -n "${SOLO_NAMESPACE}" port-forward svc/haproxy-node1-svc 50211:50211 > /tmp/pf-50211.log 2>&1 & echo $! > /tmp/pf-50211.pid
          # Explorer UI
          kubectl -n "${SOLO_NAMESPACE}" port-forward svc/hiero-explorer 8080:80 > /tmp/pf-explorer.log 2>&1 & echo $! > /tmp/pf-explorer.pid
          # Mirror Node gRPC
          kubectl -n "${SOLO_NAMESPACE}" port-forward svc/mirror-grpc 5600:5600 > /tmp/pf-mgrpc.log 2>&1 & echo $! > /tmp/pf-mgrpc.pid
          # Mirror Node REST
          kubectl -n "${SOLO_NAMESPACE}" port-forward svc/mirror-rest 5551:80 > /tmp/pf-mrest.log 2>&1 & echo $! > /tmp/pf-mrest.pid
          # Mirror Node REST Java
          kubectl -n "${SOLO_NAMESPACE}" port-forward svc/mirror-restjava 8084:80 > /tmp/pf-mrestjava.log 2>&1 & echo $! > /tmp/pf-mrestjava.pid
          # Verify gRPC port for tests
          sleep 3
          nc -z 127.0.0.1 50211

      # ---- Tests ----
      - name: Write .env for tests
        run: |
          umask 077
          {
            echo "TEST_NETWORK_NAME=localhost"
            echo "TEST_RUN_NONFREE=1"
            echo "TEST_OPERATOR_ID=0.0.2"
            echo "TEST_OPERATOR_KEY=302e020100300506032b65700422042091132178e72057a1d7528025956fe39b0b847f200ab59b2fdd367017f3087137"
          } > .env
          cat .env

      - name: Test
        run: swift test

      # ---- Always: cleanup & logs ----
      - name: Stop port-forwards
        if: always()
        run: |
          for f in /tmp/pf-*.pid; do [ -f "$f" ] && kill "$(cat "$f")" || true; done

      - name: Export kind logs
        if: always()
        run: kind export logs --name "${SOLO_CLUSTER_NAME}" ./kind-logs || true

      - name: Upload kind logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: kind-logs
          path: ./kind-logs
