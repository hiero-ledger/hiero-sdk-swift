name: Swift CI
on:
  pull_request:
  push:
    branches: ['main']

defaults:
  run:
    shell: bash

permissions:
  contents: read

jobs:
  format:
    runs-on: macos-latest
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0080882f6c36860b6ba35c610c98ce87d4e2f26f
        with:
          egress-policy: audit
      - name: Checkout Code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
      - name: Install swift-format
        run: brew install swift-format
      - name: Format
        run: swift format lint --strict --configuration .swift-format.json --recursive --parallel Sources/ Tests/ Examples/ Package.swift

  build:
    strategy:
      matrix:
        swift: ["5.9", "5.10"]
        os: [macos-13, macos-14]
    runs-on: ${{ matrix.os }}
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0080882f6c36860b6ba35c610c98ce87d4e2f26f
        with:
          egress-policy: audit
      - name: Setup Swift
        uses: swift-actions/setup-swift@3aed395c5397f62deb91d8fe7af1418a9ae4d16f
        with:
          swift-version: ${{ matrix.swift }}
      - name: Checkout Code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
      - name: Cache (SPM)
        uses: actions/cache@1bd1e32a3bdc45362d1e726936510720a7c30a57
        with:
          path: sdk/swift/.build
          key: ${{ runner.os }}-${{ matrix.swift }}-spm-${{ github.job }}-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.swift }}-spm-
      - name: Build
        run: swift build

  # macOS tests that DO NOT require Solo
  test-macos:
    needs: [build]
    strategy:
      matrix:
        swift: ["5.9", "5.10"]
        os: [macos-13, macos-14]
    runs-on: ${{ matrix.os }}
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0080882f6c36860b6ba35c610c98ce87d4e2f26f
        with:
          egress-policy: audit
      - name: Setup Swift
        uses: swift-actions/setup-swift@3aed395c5397f62deb91d8fe7af1418a9ae4d16f
        with:
          swift-version: ${{ matrix.swift }}
      - name: Checkout Code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
      - name: Cache (SPM)
        uses: actions/cache@1bd1e32a3bdc45362d1e726936510720a7c30a57
        with:
          path: sdk/swift/.build
          key: ${{ runner.os }}-${{ matrix.swift }}-spm-${{ github.job }}-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.swift }}-spm-
      - name: Test (non-Solo)
        # Exclude Solo-dependent tests; rename 'Solo' to your chosen marker
        run: swift test --filter '^(?!.*Solo).*'

  # Ubuntu job: starts Solo (Docker) and runs Solo-dependent tests
  test-linux-solo:
    needs: [build]
    runs-on: hiero-client-sdk-linux-large
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0080882f6c36860b6ba35c610c98ce87d4e2f26f
        with:
          egress-policy: audit
      - name: Checkout Code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      # Start Hiero Solo (Docker is available on Ubuntu runners)
      - name: Prepare Hiero Solo
        id: solo
        uses: hiero-ledger/hiero-solo-action@10ec96a107b8d2f5cd26b3e7ab47e65407b5c462 # v0.11.0
        with:
          installMirrorNode: true
          hieroVersion: v0.65.0

      # Install Swift on Ubuntu (same action works)
      - name: Setup Swift
        uses: swift-actions/setup-swift@3aed395c5397f62deb91d8fe7af1418a9ae4d16f
        with:
          swift-version: "5.10"

      - name: Cache (SPM)
        uses: actions/cache@1bd1e32a3bdc45362d1e726936510720a7c30a57
        with:
          path: sdk/swift/.build
          key: ${{ runner.os }}-5.10-spm-${{ github.job }}-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-5.10-spm-

      - name: Env for Solo (adjust if your code reads different vars)
        run: |
          echo "HEDERA_NETWORK=127.0.0.1:50211" >> $GITHUB_ENV
          echo "MIRROR_NODE_URL=http://127.0.0.1:5600" >> $GITHUB_ENV

      - name: Test (Solo-dependent)
        # Only run the Solo tests here
        run: swift test --filter 'Solo'
